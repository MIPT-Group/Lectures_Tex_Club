\subsection{Квадратичные вычеты}

\begin{definition}
	Пусть $m \in \N$. Число $a \in \N$ называется \textit{квадратичным вычетом} по модулю $m$, если выполнены условия:
	\begin{enumerate}
		\item $(a, m) = 1$
		
		\item $x^2 \equiv a \pmod m$
	\end{enumerate}
\end{definition}

\begin{note}
	Все остальные числа, что не являются вычетом для данного $m$, называются \textit{невычетами}.
\end{note}

\begin{theorem} (Лагранжа)
	Пусть $f(x)$ - многочлен степени $m$ с целыми коэффициентами, а $p$ - произвольное простое число. Тогда из сравнения
	\[
		f(x) \equiv 0 \pmod p
	\]
	может следовать лишь 2 факта:
	\begin{itemize}
		\item Либо у $f(x)$ не более $m$ корней в данном сравнении (с точностью до класса вычета);
		
		\item Либо все коэффициенты $f(x)$ кратны $p$.
	\end{itemize}
\end{theorem}

\begin{proof}
	Так как $p$ - простое число, то $\Z_p$ - поле. Предположим, что существует $m + 1$ различное решение, которые обозначим за $x_1, \ldots, x_{m + 1}$. Тогда, $f(x)$ может быть записано в виде
	\[
		f(x) = k_m (x - x_1) \cdot \ldots \cdot (x - x_m) + k_{m - 1} (x - x_1) \cdot \ldots \cdot (x - x_{m - 1}) + \ldots + k_1 (x - x_1) + k_0
	\]
	где $k_0, \ldots, k_m$ - целые числа (по условию, степень многочлена $m$, а потому данная запись имеет место быть). Теперь будем последовательно подставлять корни многочлена и выяснять коэффициенты:
	\begin{align*}
		&{{f(x_1) \equiv 0 \pmod p} \Ra k_0 \equiv 0 \pmod p}
		\\
		&{{f(x_2) \equiv 0 \pmod p} \Ra k_1 \equiv 0 \pmod p}
		\\
		&\vdots
		\\
		&{{f(x_{m + 1}) \equiv 0 \pmod p} \Ra k_m \equiv 0 \pmod p}
	\end{align*}
	Если какой-то коэффициент не кратен $p$, то получим противоречие с предположением. В ином случае, многочлен будет сравним с нулевым и, стало быть, любой $x$ будет решением.
\end{proof}

\begin{corollary}
	У сравнения $x^2 \equiv a \pmod p$ не более двух решений.
\end{corollary}

\begin{note}
	Более того, у сравнения $x^2 \equiv a \pmod p$ если и есть решение, то их ровно два: действительно, если $x$ - решение, то и $(-x)$ - тоже:
	\[
		(-x)^2 = x^2 \equiv a \pmod p
	\]
	
	Отдельно отметим, для разных квадратичных вычетов $a_1$ и $a_2$ всегда получаются разные решения $\pm x_1,\ \pm x_2$.
\end{note}

\begin{note}
	Далее и до конца параграфа мы считаем, что $m = p$ - простое число, причём $p > 2$.
\end{note}

\begin{proposition} (о квадратичных вычетах и Малой Теореме Ферма)
	Если в сравнении $a^{p - 1} \equiv 1 \pmod p$ $a$ является квадратичным вычетом, то также верно сравнение
	\[
		a^{\frac{p - 1}{2}} \equiv 1 \pmod p
	\]
\end{proposition}

\begin{proof}
	Распишем сравнение Малой Теоремы Ферма в следующем виде:
	\[
		{a^{p - 1} \equiv 1\!\! \pmod p}\ \ \lra\ \ {a^{p - 1} - 1 \equiv 0 \equiv (a^{\frac{p - 1}{2}} - 1)(a^{\frac{p - 1}{2}} + 1)\!\! \pmod p}
	\]
	Если $a$ - квадратичный вычет, то $\exists x_1 \in \Z_p$ такой, что
	\[
		x_1^2 \equiv a \pmod p
	\]
	Отсюда получаем
	\[
		a^{\frac{p - 1}{2}} \equiv (x_1^2)^{\frac{p - 1}{2}} = x_1^{p - 1} \equiv 1 \pmod p
	\]
\end{proof}

\begin{corollary}
	Для всех квадратичных вычетов по модулю $p$ верно, что
	\[
		a^{\frac{p - 1}{2}} \equiv 1 \pmod p
	\]
	а для всех невычетов (то есть оставшихся чисел) верно другое
	\[
		a^{\frac{p - 1}{2}} \equiv -1 \pmod p
	\]
\end{corollary}

\begin{definition}
	\textit{Символом Лежандра} $\legSym{a}{p}$ называется функция от целого числа $a$ и \underline{простого} числа $p$, определяемая следующим образом:
	\[
		\legSym{a}{p} = \System{
			&{1, \text{ если } a \text{ - квадратичный вычет}}
			\\
			&{0,\ \ a \equiv 0 \pmod p}
			\\
			&{-1, \text{ если } a \text{ - квадратичный невычет}}
		}
	\]
\end{definition}

\begin{note}
	Фактически символ Лежандра является значением сравнения
	\[
		\legSym{a}{p} \equiv a^{\frac{p - 1}{2}} \pmod p
	\]
	Из этого также следует как минимум 2 значения этого символа:
	\[
		\legSym{1}{p} = 1;\ \ \legSym{-1}{p} = (-1)^{\frac{p - 1}{2}}
	\]
\end{note}

\begin{proposition}
	\[
		\suml_{a = 1}^p \legSym{a}{p} = 0
	\]
\end{proposition}

\begin{proof}
	Уже доказано, что число невычетов и вычетов совпадает. Отсюда напрямую следует заявленное равенство.
\end{proof}

\begin{proposition}
	Символ Лежандра мультипликативен, то есть
	\[
		\legSym{ab}{p} = \legSym{a}{p} \cdot \legSym{b}{p}
	\]
\end{proposition}

\begin{proof}
	Напрямую следует из замечания.
\end{proof}

\begin{theorem}~
	\[
		\legSym{2}{p} = (-1)^{\frac{p^2 - 1}{8}}
	\]
\end{theorem}

\begin{proof}
	Зафиксируем любое $a$ такое, что $(a, p) = 1$.
	\begin{proposition}~
		\[
			a^{\frac{p - 1}{2}} \equiv \eps_1 \cdot \ldots \cdot \eps_{\frac{p - 1}{2}} \pmod p
		\]
		где $\eps_i = \pm 1$ - знак представителя числа $a \cdot i$ в системе вычетов $\left[-\frac{p - 1}{2},\ \frac{p - 1}{2}\right]$
	\end{proposition}

	\begin{proof}
		Рассмотрим множество чисел $\{a \cdot 1, a \cdot 2, \ldots, a \cdot p_1\}$, где $p_1 = \frac{p - 1}{2}$. Эти числа сравнимы со следующими:
		\begin{align*}
			&{a \cdot 1 \equiv \eps_1 r_1 \pmod p}
			\\
			&\vdots
			\\
			&{a \cdot p_1 \equiv \eps_{p_1} r_{p_1} \pmod p}
		\end{align*}
		где $\eps_i = \pm 1$, $r_i \in \{1, \ldots, p_1\}$. Почему это так? Потому что увидим, что всевозможные произведения данных чисел дают систему вычетов $\left[-\frac{p - 1}{2}, \ldots, \frac{p - 1}{2}\right]$. Теперь, перемножим все имеющиеся сравнения. Получим новое:
		\[
			a^{\frac{p - 1}{2}} (1 \cdot \ldots \cdot p_1) \equiv \eps_1 \cdot \ldots \cdot \eps_{p_1} \cdot (r_1 \cdot \ldots \cdot r_{p_1}) \pmod p
		\]
		Заметим, что произведения в скобках слева и справа должны совпадать, так как никакие 2 числа вида $a \cdot x$ и $a \cdot y$ не совпадают:
		\begin{itemize}
			\item Если $a \cdot x \equiv \eps r,\ a \cdot y \equiv \eps r \pmod p$, то очевидным образом $x = y$.
			
			\item Если $a \cdot x \equiv \eps r,\ a \cdot y \equiv -\eps r \pmod p$, то $a(x + y) \equiv 0 \pmod p$, где $(a, p) = 1$ и $x + y < p$. Такого быть не может.
			
			\item Остальные случаи очевидны.
		\end{itemize}
	
		Получили утверждение следующего вида:
		\[
			a^{\frac{p - 1}{2}} \equiv \eps_1 \cdot \ldots \cdot \eps_{p_1} \pmod p
		\]
	\end{proof}

	\begin{corollary}~
		\[
			\legSym{a}{p} = \eps_1 \cdot \ldots \cdot \eps_{\frac{p - 1}{2}}
		\]
	\end{corollary}
	
	\begin{proposition}
		\[\eps_x = (-1)^{\floor{\frac{2ax}{p}}}\]
	\end{proposition}

	\begin{proof}
		Разобьём числовую прямую на системы вычетов:
		\[
			\ldots \cup \{0, 1, \ldots, p - 1\} \cup \{p, \ldots, 2p - 1\} \cup \ldots
		\]
		Далее возможно 2 случая, где окажется $ax$:
		\begin{itemize}
			\item $ax$ в первой половине некоторой системы вычетов. То есть для некоторого $k$ верно неравенство:
			\[
				kp + 1 \le ax \le kp + \frac{p - 1}{2}
			\]
			Домножим на 2 и посмотрим, что получится
			\[
				2kp + 2 \le 2ax \le 2kp + p - 1
			\]
			То есть число $2ax$ лежит в системе, начинающаяся с $2kp$. Отсюда уже получаем
			\[
				2k + \frac{2}{p} \le \frac{2ax}{p} \le 2k + \frac{p - 1}{p}
			\]
			В итоге добились требуемого:
			\[
				\floor{\frac{2ax}{p}} = 2k \Ra \eps_x = 1 = (-1)^{2k}
			\]
			
			\item $a$ во второй половине некоторой системы вычетов. Поступаем аналогично предыдущему пункту.
		\end{itemize}
	\end{proof}

	\begin{corollary}~
		\[
			\legSym{a}{p} = (-1)^{\suml_{x = 1}^{p_1} \floor{\frac{2ax}{p}}}
		\]
	\end{corollary}

	\begin{proposition}
		Если $a$ - нечётное число, то
		\[
			\legSym{2a}{p} = (-1)^{\suml_{x = 1}^{p_1} \floor{\frac{ax}{p}} + \frac{p^2 - 1}{8}}
		\]
	\end{proposition}

	\begin{proof}
		Распишем символ Лежандра, описываемый в теореме:
		\[
			\legSym{2a}{p} = \legSym{2a + 2p}{p} = \legSym{4((a + p) / 2)}{p} = \legSym{4}{p} \cdot \legSym{(1/2) \cdot (a + p)}{p} = (-1)^{\suml_{x = 1}^{p_1} \floor{\frac{(a + p)x}{p}}}
		\]
		Осталось лишь немного преобразовать степень:
		\[
			\suml_{x = 1}^{p_1} \floor{\frac{(a + p)x}{p}} = \suml_{x = 1}^{p_1} \left(\floor{\frac{ax}{p}} + x\right) = \suml_{x = 1}^{p_1} \floor{\frac{ax}{p}} + \frac{p_1(p_1 + 1)}{2} = \suml_{x = 1}^{p_1} \floor{\frac{ax}{p}} + \frac{p^2 - 1}{8}
		\]
	\end{proof}

	В выражение последнего утверждения остаётся подставить $a = 1$ и получить требуемое:
	\[
		\legSym{a}{p} = (-1)^{\suml_{x = 1}^{p_1} \floor{\frac{x}{p}} + \frac{p^2 - 1}{8}} = (-1)^{\frac{p^2 - 1}{8}}
	\]
\end{proof}

\begin{corollary}
	Если $a$ - нечётно, то
	\[
		\legSym{a}{p} = (-1)^{\suml_{x = 1}^{p_1} \floor{\frac{ax}{p}}}
	\]
\end{corollary}

\begin{proof}
	Пользуясь уже доказанным, распишем символ Лежандра для $2a$:
	\[
		\legSym{2a}{p} = (-1)^{\suml_{x = 1}^{p_1} \floor{\frac{ax}{p}} + \frac{p^2 - 1}{8}} = \legSym{2}{p} \cdot \legSym{a}{p} = (-1)^{\frac{p^2 - 1}{8}} \cdot \legSym{a}{p}
	\]
	Откуда уже следует нужное равенство.
\end{proof}

\begin{theorem} (Квадратичный закон взаимности)
	Если $p, q$ - нечётные простые числа, то
	\[
		\legSym{p}{q} \cdot \legSym{q}{p} = (-1)^{p_1 \cdot q_1}
	\]
	где $p_1 = \frac{p - 1}{2},\ q_1 = \frac{q - 1}{2}$
\end{theorem}

\begin{proof}
	По уже доказанному, распишем произведение символов из теоремы:
	\[
		\legSym{p}{q} \cdot \legSym{q}{p} = (-1)^{\suml_{x = 1}^{q_1} \floor{\frac{qx}{p}} + \suml_{y = 1}^{p_1} \floor{\frac{py}{q}}}
	\]
	То есть всё сводится к доказательству того, что
	\[
		\suml_{x = 1}^{q_1} \floor{\frac{qx}{p}} + \suml_{y = 1}^{p_1} \floor{\frac{py}{q}} = p_1 \cdot q_1
	\]
	Для этого воспользуемся комбинаторикой: подсчитаем количество пар чисел $(x, y)$ таких, что $1 \le x \le p_1,\ 1 \le y \le q_1$. Их всего $p_1 \cdot q_1$. Заметим, что среди них нет пар таких, что $py = qx$:
	
	Если бы это было не так, то без умаления общности положим $p > q$. Равенство возможно лишь тогда, когда $x \ge p > q$ - противоречие.
	
	Из этого следует, что все пары делятся на 2 группы, которые мы тоже посчитаем:
	\begin{itemize}
		\item $qx < py \lra x \le \floor{\frac{py}{q}}$. Отсюда получаем возможность посчитать количество $K_1$ пар в данной группе:
		\[
			K_1 = \suml_{y = 1}^{q_1} \floor{\frac{py}{q}}
		\]
		Почему все $y$ будут корректными? То есть не случится такого, что $\floor{\frac{py}{q}} > p_1$?
		\[
			y \le q_1 = \frac{q - 1}{2} \Ra \frac{py}{q} \le \frac{p(q - 1)}{2q} = \frac{p - 1}{2} + \frac{q - p}{2q}
		\]
		Несложно проверить арифметическими операциями, что $\frac{q - p}{2q} < 1$. То есть всё хорошо округлится и никаких выходов за границы не случится.
		
		\item Аналогично предыдущему случаю. Число этих пар - $K_2$ получается равным
		\[
			K_2 = \suml_{x = 1}^{p_1} \floor{\frac{qx}{p}}
		\]
	\end{itemize}
	По уже обоснованной причине имеем следующее равенство:
	\[
		K_1 + K_2 = \suml_{x = 1}^{q_1} \floor{\frac{qx}{p}} + \suml_{y = 1}^{p_1} \floor{\frac{py}{q}} = p_1 \cdot q_1
	\]
\end{proof}